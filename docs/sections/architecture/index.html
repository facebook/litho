<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-28","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Litho" href="/opensearch.xml"><title data-react-helmet="true">Internal üèó: Sections implementation architecture | Litho</title><meta data-react-helmet="true" property="og:url" content="https://fblitho.com/docs/sections/architecture"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Internal üèó: Sections implementation architecture | Litho"><meta data-react-helmet="true" name="description" content="This document gives an insight into the implementation of Sections, for those hackers and code explorers who want to take a peek behind the scenes for inspiration or to contribute. The understanding of the implementation details described in this document are not necessary for just using Sections."><meta data-react-helmet="true" property="og:description" content="This document gives an insight into the implementation of Sections, for those hackers and code explorers who want to take a peek behind the scenes for inspiration or to contribute. The understanding of the implementation details described in this document are not necessary for just using Sections."><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fblitho.com/docs/sections/architecture"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/sections/architecture" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/sections/architecture" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.7fecd722.css">
<link rel="preload" href="/assets/js/runtime~main.c13abd95.js" as="script">
<link rel="preload" href="/assets/js/main.f78999c6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Litho</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro/motivation">Docs</a><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a><a class="navbar__item navbar__link" href="/docs/tutorial/overview">Tutorial</a><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What is Litho?</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Main Concepts</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Building lists</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/start">Basics: DiffSection and GroupSection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/recycler-collection-component">Adding and adapting RecyclerCollection to your App</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/best-practices">Best Practices and Performance</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/hscrolls">Nested scrolling and measurement</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/api-overview">API üìÑ: annotations, events and lifecycles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/working-ranges">Advanced: Prefetch and pagination</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/services">Advanced: Granular Dependency Injection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/view-support">Advanced: Mixing with Android Views</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/diff-sections">Advanced: Writing your own DiffSection</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/sections/architecture">Internal üèó: Sections implementation architecture</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Widgets</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Developer Tools</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Testing</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Animations</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Accessibility</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Performance</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deep Dive</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contributing Documentation</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_1lV3"><div class="docItemContainer_zt2Y"><article><header><h1 class="docTitle_1y8q">Internal üèó: Sections implementation architecture</h1></header><div class="markdown"><p>This document gives an insight into the implementation of Sections, for those hackers and code explorers who want to take a peek behind the scenes for inspiration or to contribute. The understanding of the implementation details described in this document are not necessary for just using Sections.</p><p>At its core, the Sections framework is responsible for producing a <a href="/javadoc/com/facebook/litho/sections/ChangeSet.html" target="_blank" rel="noopener noreferrer">ChangeSet</a> from immutable props and a hierarchy of <a href="/javadoc/com/facebook/litho/sections/Section.html" target="_blank" rel="noopener noreferrer">Sections</a>. The framework produces these <code>ChangeSets</code> by creating a new section hierarchy whenever a <code>SectionTree</code> is set with a Section with new props or whenever a Section in the hierarchy updates it&#x27;s internal state and comparing the new hierarchy with the old hierarchy.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-is-a-sectiontree"></a>What is a SectionTree?<a class="hash-link" href="#what-is-a-sectiontree" title="Direct link to heading">#</a></h2><p>Using the Sections framework begins with creating a <a href="/javadoc/com/facebook/litho/sections/SectionTree.html" target="_blank" rel="noopener noreferrer">SectionTree</a>. <code>SectionTree</code> instances are responsible for:</p><ul><li>Computing/Recomputing changes whenever state &amp; props values change.</li><li>Communicate with a <a href="/javadoc/com/facebook/litho/sections/SectionTree.Target.html" target="_blank" rel="noopener noreferrer">Target</a> implementation that can update UI (including telling the <code>Target</code> about new changes).</li></ul><p>SectionTrees must be created with a <code>Target</code> implementation. The <a href="/javadoc/com/facebook/litho/sections/SectionTree.Target.html" target="_blank" rel="noopener noreferrer">Target</a> interface is the API between <code>SectionTree</code> and UI. After computing a ChangeSet from a section hierarchy, a <code>SectionTree</code> instance will relay the changes to it&#x27;s <code>Target</code>. You can create a target for whatever custom UI you want but the Sections framework has already implemented some <code>Targets</code> for you. <a href="/javadoc/com/facebook/litho/sections/widget/SectionBinderTarget.html" target="_blank" rel="noopener noreferrer">SectionBinderTarget</a> is one a <code>Target</code> implementation that relays changes to a <code>RecyclerBinder</code> for rendering.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updating-the-sectiontree"></a>Updating the SectionTree<a class="hash-link" href="#updating-the-sectiontree" title="Direct link to heading">#</a></h2><p>The framework can perform incremental and conditional updates on the structure of Sections whenever any props or state values change. The infrastructure also calculates the minimal operations it needs to perform on the existing hierarchy to update the list to reflect the new data.</p><p>To update a section tree to reflect new props, create a section with the new prop values and call <a href="/javadoc/com/facebook/litho/sections/SectionTree.html#setRoot-com.facebook.litho.sections.Section-" target="_blank" rel="noopener noreferrer">SectionTree#setRoot()</a>. This is also how you set an initial root section on a tree since it&#x27;s essentially diffing a new section hierarchy with an empty hierarchy.</p><p>To update a section tree when a state value changes, just perform a regular state update as described in the documentation for litho <a href="/docs/mainconcepts/coordinate-state-actions/state-overview">State</a>.</p><p>You may notice that the <code>setRoot()</code> and <code>updateState()</code> methods also have &quot;async&quot; implementations (<code>setRootAsync()</code> and <code>updateStateAsync()</code>).  The <code>*async()</code> methods will ensure that the resulting ChangeSet calculation is performed on a background thread.  Otherwise the resulting ChangeSet calculation will be done synchronously on whatever thread <code>setRoot()</code> or <code>updateState()</code> was called. This is just like Litho&#x27;s <a href="/docs/asynchronous-layout#sync-and-async-operations">asychronous layout</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="computing-changesets"></a>Computing ChangeSets<a class="hash-link" href="#computing-changesets" title="Direct link to heading">#</a></h2><p><code>SectionTree</code> instances compute changes in two steps: generating trees based on props/state values, then creating a changeset by comparing two trees.</p><p>A tree is generated from a single root section by recursively calling <code>@OnCreateChildren</code> on group section specs until it reaches the leaf sections, diff section specs.  As it visits a new section, <code>SectionTree</code> will:</p><ul><li>Create a new <code>SectionContext</code> scoped to this new section</li><li>Check if there&#x27;s a corresponding section in the current hierarchy (via <a href="/docs/mainconcepts/coordinate-state-actions/state-overview#keys-and-identifying-components">key</a>) and transfer any state and service values over to the new section.</li><li>Check if there&#x27;s any pending state updates for the new section (via <a href="/docs/mainconcepts/coordinate-state-actions/state-overview#keys-and-identifying-components">key</a>) and perform the updates if they exist.</li><li>Create the new child sections by calling <code>SectionLifecycle#createChildren</code> and recursively visit those child sections.</li></ul><p>After generating a new tree, <code>SectionTree</code> will recursively traverse the new tree and compare it against the current tree to generate a <code>ChangeSet</code>. This is where we call <code>SectionLifecycle#generateChangeSet</code> on Diff Sections. When traversing the new tree, the framework translates local indexes to global indexes as it merges all <code>ChangeSet</code>s into a single <code>ChangeSet</code> for the whole hierarchy.</p><p>NOTE: <a href="/javadoc/com/facebook/litho/sections/SectionContext.html" target="_blank" rel="noopener noreferrer">SectionContext</a> is an object that is used to associate each <code>Section</code> instance in a hierarchy with it&#x27;s <code>SectionTree</code>.  <code>SectionContext</code> instances are released and recreated every time a <code>SectionTree</code> re-calculates it&#x27;s changeset (anytime props or state change). This means you should not rely on the <code>SectionContext</code> passed into your spec delegate methods to always be associated with a valid <code>Section</code> instance.  As a general rule, a <code>SectionContext</code> object is only valid between the <code>@OnBindService</code> and <code>@OnUnbindService</code> methods. You should not keep an instance of <code>SectionContext</code> alive outside this window.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sectiontree-and-recyclercollectioncomponent"></a>SectionTree and RecyclerCollectionComponent<a class="hash-link" href="#sectiontree-and-recyclercollectioncomponent" title="Direct link to heading">#</a></h3><p><a href="/docs/sections/recycler-collection-component">RecyclerCollectionComponent</a> is a Litho component that creates and binds a <code>SectionTree</code> to a <code>Recycler</code> behind the scenes to make it incredibly easy to use the Sections framework with Litho. <code>RecyclerCollectionComponent</code> creates and holds onto a <code>SectionTree</code> instance as state and exposes a prop to accept new sections.  Updating the SectionTree when using RecyclerCollectionComponent is as simple as updating the section prop passed into it.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/litho/edit/master/website/../docs/sections/architecture.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/sections/diff-sections"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Advanced: Writing your own DiffSection</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/widgets/builtin-widgets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Built-in widgets ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-sectiontree" class="table-of-contents__link">What is a SectionTree?</a></li><li><a href="#updating-the-sectiontree" class="table-of-contents__link">Updating the SectionTree</a></li><li><a href="#computing-changesets" class="table-of-contents__link">Computing ChangeSets</a><ul><li><a href="#sectiontree-and-recyclercollectioncomponent" class="table-of-contents__link">SectionTree and RecyclerCollectionComponent</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li><li class="footer__item"><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/contributing">How To Contribute</a></li><li class="footer__item"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Open Source Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/fblitho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2021 Facebook, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c13abd95.js"></script>
<script src="/assets/js/main.f78999c6.js"></script>
</body>
</html>